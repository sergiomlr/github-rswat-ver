---
title: "TEMPAWN"
output: html_notebook
---

Loading R packages

```{r}
library(SWATplusR)
library(sensitivity)
library(fast)
library(hydroGOF)
library(dplyr)
library(forcats)
library(tidyr)
library(ggplot2)
library(lhs)
library(purrr)
library(lubridate)

#Load temPAWN
library(temPAWN)

```

Loading model

```{r}
# The path where the SWAT project is written

path_2012 <- "/home/sergio/Documents/R/github-rswat-ver/swat_models/TxtInOut"

# Daily observed discharge gavilanes outlet (2015-05-02 to 2016-09-12)
q_obs <- q_obs_gav 

```

```{r}
par_bound <- tibble("CN2.mgt|change = abschg" = c(-15, 15),
                    "SURLAG.bsn|change = absval"= c(0, 10),
                    "SOL_AWC.sol|change = relchg"= c(-0.4, 0.4),
                    "RCHRG_DP.gw|change = absval"= c(0, 1),
                    "GW_DELAY.gw|change = absval"= c(0, 650),
                    "ALPHA_BF.gw|change = absval"= c(0, 1),
                    "CANMX.hru|change = abschg" = c(0, 6),
                    "ESCO.hru|change = absval" = c(0, 1),
                    "SOL_K.sol|change = relchg" = c(-0.8, 0.8),
                    "CH_K2.rte|change = absval"= c(5, 130),
                    "CH_N2.rte|change = absval"= c(0, 0.3)
                    )

n_sample <- 5000
n_par <- ncol(par_bound)

par_pwn <- randomLHS(n = n_sample, k = n_par) %>%
  as_tibble(., .name_repair = "minimal") %>%
  map2_df(., par_bound, ~ (.x * (.y[2] - .y[1]) + .y[1])) %>%
  set_names(names(par_bound))


sim_pwn <- run_swat2012(project_path = path_2012,
            output = list(q_out = define_output(file = "rch",
                                  variable = "FLOW_OUT",
                                  unit = c(14,15))), # gavilanes = 15, pixquiac = 14
            parameter = par_pwn,
            start_date = "2014-01-01",
            end_date = "2017-12-31",
            years_skip = 1,
            n_thread = 4)
```

Gavilanes 
The model runs are evaluated using the NSE criterion for daily discharge from 2015-05-02 to 2017-04-30

```{r}

#subset the q_sim based on q_obs using date gavilanes
q_lhc_g <- sim_pwn$simulation$q_out_15[sim_pwn$simulation$q_out_15$date %in% q_obs$Date,]

gav$q5 <- apply(q_lhc_g[2:ncol(q_lhc_g)],1 , function(x) quantile(as.numeric(x),0.05))
gav$q95 <- apply(q_lhc_g[2:ncol(q_lhc_g)],1 , function(x) quantile(as.numeric(x),0.95))


#Nash sutclife
nse_lhc_g <- q_lhc_g %>%
  select(-date) %>%
  map_dbl(., ~NSE(.x, q_obs$Q_m3_s))

#Coefficient of determination

r2_lhc_g <- q_lhc_g %>%
  select(-date) %>%
  map_dbl(., ~cor(., q_obs$Q_m3_s, method="pearson")^2) # Apply NSE function using q_sim, q_obs


```

#Visualization of with the PAWN method

```{r}
#Create a copy of the sim_pwn
sim_pwn.g <- sim_pwn[c(1,2)] 
#Remove pixquiac results
sim_pwn.g$simulation$q_out_14 <- NULL 


#Create a copy of the sim_pwn
sim_pwn.p <- sim_pwn[c(1,2)] 
#Remove pixquiac results
sim_pwn.p$simulation$q_out_15 <- NULL 

#Run pwn
pwn.p <- tempawn(sim = sim_pwn.p)

#Group by months
pwn_mon <- pwn.p$sensitivity$q_out_14%>%
  mutate(month = format(date, "%m"))%>%
  group_by(month)%>%
  summarize_all(., ~mean(.))%>%
  pivot_longer(., cols = colnames(pwn_mon[3:ncol(.)]), names_to ="parameter") # Create a long table

#Plot a lon
ggplot(pwn_mon,aes(month,parameter,fill=value))+geom_tile()+scale_fill_gradient(low="white", high="tomato")+theme(axis.ticks = element_blank(), 
        panel.background = element_blank(), 
        plot.title = element_text(size = 12, colour = "gray50")) 

```

Visualization of 5 and 95 ppu bands

```{r}
#Visualization tempPAWN for FDC
fdc_sim <- pwn$simulation$q_out_15%>%
  arrange(., desc(sim_max))%>%
  mutate(p = seq(0,1, length.out = nrow(.))) # This needs to consider n + 1 

ggplot(fdc_sim) +
  geom_smooth(aes(x = p, y = sim_min), method = loess) +
  geom_smooth(aes(x = p, y = sim_max), method = loess) +
  labs(y = "FDC") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank())

ggplot(fdc_sim) +
  geom_smooth(aes(x = p, y = sim_min), method = loess) +
  geom_smooth(aes(x = p, y = sim_max), method = loess) +
  labs(y = "FDC") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank())



My_Theme = theme(plot.title = element_text(face = "bold", size= 16),axis.title = element_text(size= 14), 
                 axis.text = element_text(size = 18), legend.title = element_text(size=16), 
                 legend.text = element_text(size=16)) + theme_classic(base_size = 16)

#Plot the best 
ggplot() + geom_ribbon(data=gav, aes(x =Date, ymin = q5, ymax = q95),fill = "green", alpha = .5) +
  geom_line(data=gav, aes(Date,q_obs, colour="obs"))+ geom_polygon() +
  geom_line(data=gav, aes(Date,q_sim, colour="sim"))+ geom_polygon()+
  theme(legend.position="top") +labs(colour="",x=" Date", y="Discharge m^3/S") + My_Theme


ggplot(dat, aes(x = time, y = bgl, group = order)) +geom_line(aes(colour = factor(order))) +
geom_point(aes(colour = factor(order))) +geom_polygon(data = dat2, aes(y = bgl, 
    group = group), alpha = 0.3) +facet_wrap(~id)


```
